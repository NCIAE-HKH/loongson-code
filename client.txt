import wx
import wx.adv
import paramiko
import subprocess
import threading
import socket
import os
import cv2
import numpy as np
from datetime import datetime, timedelta
import time
import psutil

class IndustrialSecurityClient(wx.Frame):
    def __init__(self):
        super().__init__(None, title="å·¥ä¸šæ™ºèƒ½å®‰é˜²ç³»ç»Ÿ", size=(1200, 800))
        
        # è®¾å¤‡ç®¡ç†
        self.devices = [
            {
                "name": "è®¾å¤‡ 1",
                "ip": "192.168.1.162",
                "user": "long2",
                "password": "long222",
                "script_path": "/home/long2/projects/my_project",
                "history_path": "/home/long2",
                "bound": True
            }
        ]
        self.current_device = self.devices[0]
        
        # PCç«¯é…ç½®
        self.pc_script_path = "D:\æ¡Œé¢\æ–°å»ºæ–‡ä»¶å¤¹ (2)"
        self.pc_ip = "192.168.1.166"
        self.video_port = 5002
        self.audio_port = 5003
        
        # è¿è¡ŒçŠ¶æ€
        self.is_receiving = False
        self.receiving_thread = None
        self.processes = {}
        
        # åˆå§‹åŒ–UI
        self.init_ui()
        
        # å¯åŠ¨å®šæ—¶å™¨
        self.timer = wx.Timer(self)
        self.Bind(wx.EVT_TIMER, self.on_timer)
        self.timer.Start(1000)
        
        # æœ€å¤§åŒ–çª—å£
        self.Maximize(True)
    
    def init_ui(self):
        # è®¾ç½®èƒŒæ™¯è‰²
        self.SetBackgroundColour(wx.Colour(240, 245, 250))
        
        # åˆ›å»ºä¸»é¢æ¿
        panel = wx.Panel(self)
        main_sizer = wx.BoxSizer(wx.VERTICAL)
        
        # æ ‡é¢˜æ 
        title_sizer = wx.BoxSizer(wx.HORIZONTAL)
        title = wx.StaticText(panel, label="å·¥ä¸šæ™ºèƒ½å®‰é˜²ç³»ç»Ÿæ§åˆ¶ä¸­å¿ƒ")
        title.SetFont(wx.Font(18, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_BOLD))
        title.SetForegroundColour(wx.Colour(25, 75, 125))
        title_sizer.Add(title, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 10)
        
        # ç³»ç»Ÿæ—¶é—´
        self.time_display = wx.StaticText(panel, label=datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        self.time_display.SetFont(wx.Font(12, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_NORMAL))
        title_sizer.AddStretchSpacer(1)
        title_sizer.Add(self.time_display, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 10)
        main_sizer.Add(title_sizer, 0, wx.EXPAND)
        
        # è®¾å¤‡æ§åˆ¶åŒºåŸŸ
        device_ctrl_sizer = wx.StaticBoxSizer(wx.VERTICAL, panel, "è®¾å¤‡ç®¡ç†")
        grid_sizer = wx.GridSizer(rows=1, cols=4, gap=wx.Size(10, 10))
        
        # è®¾å¤‡é€‰æ‹©
        device_choice_sizer = wx.BoxSizer(wx.VERTICAL)
        device_label = wx.StaticText(panel, label="é€‰æ‹©è®¾å¤‡:")
        device_label.SetFont(wx.Font(12, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_BOLD))
        device_choice_sizer.Add(device_label, 0, wx.BOTTOM, 5)
        self.device_combo = wx.ComboBox(panel, choices=[dev['name'] for dev in self.devices],
                                       style=wx.CB_READONLY, size=(150, -1))
        self.device_combo.SetSelection(0)
        device_choice_sizer.Add(self.device_combo, 0, wx.EXPAND)
        grid_sizer.Add(device_choice_sizer, 0, wx.EXPAND)
        
        # è®¾å¤‡ä¿¡æ¯
        device_info_sizer = wx.BoxSizer(wx.VERTICAL)
        self.device_info = wx.StaticText(panel, label=f"IP: {self.current_device['ip']}\nçŠ¶æ€: åœ¨çº¿")
        self.device_info.SetFont(wx.Font(11, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_NORMAL))
        device_info_sizer.Add(self.device_info, 0, wx.EXPAND)
        grid_sizer.Add(device_info_sizer, 1, wx.EXPAND)
        
        # ç»‘å®šæŒ‰é’®
        self.bind_btn = wx.Button(panel, label="ç»‘å®šè®¾å¤‡", size=(100, 35))
        self.bind_btn.SetBackgroundColour(wx.Colour(100, 180, 100))
        grid_sizer.Add(self.bind_btn, 0, wx.ALIGN_CENTER_VERTICAL)
        
        # æ·»åŠ è®¾å¤‡æŒ‰é’®
        self.add_device_btn = wx.Button(panel, label="æ·»åŠ æ–°è®¾å¤‡", size=(100, 35))
        grid_sizer.Add(self.add_device_btn, 0, wx.ALIGN_CENTER_VERTICAL)
        
        device_ctrl_sizer.Add(grid_sizer, 0, wx.EXPAND | wx.ALL, 10)
        main_sizer.Add(device_ctrl_sizer, 0, wx.EXPAND | wx.ALL, 10)
        
        # åŠŸèƒ½æŒ‰é’®åŒºåŸŸ - æ”¹ä¸º3è¡Œ2åˆ—å¸ƒå±€
        function_sizer = wx.StaticBoxSizer(wx.VERTICAL, panel, "ç³»ç»ŸåŠŸèƒ½")
        btn_grid = wx.GridSizer(rows=3, cols=2, gap=wx.Size(15, 15))
        
        # å®æ—¶ç›‘æ§æŒ‰é’®
        self.realtime_btn = self.create_func_button(panel, "å®æ—¶ç›‘æ§", "video", wx.Colour(70, 140, 210))
        btn_grid.Add(self.realtime_btn, 0, wx.EXPAND)
        
        # å§¿æ€è¯†åˆ«æŒ‰é’®
        self.pose_btn = self.create_func_button(panel, "å§¿æ€è¯†åˆ«", "pose", wx.Colour(210, 140, 70))
        btn_grid.Add(self.pose_btn, 0, wx.EXPAND)
        
        # ç«ç„°æŠ¥è­¦æŒ‰é’®
        self.fire_btn = self.create_func_button(panel, "ç«ç„°æŠ¥è­¦", "fire", wx.Colour(210, 70, 70))
        btn_grid.Add(self.fire_btn, 0, wx.EXPAND)
        
        # å†å²ç›‘æ§æŒ‰é’®
        self.history_btn = self.create_func_button(panel, "å†å²ç›‘æ§", "history", wx.Colour(120, 180, 120))
        btn_grid.Add(self.history_btn, 0, wx.EXPAND)
        
        # äººè„¸è¯†åˆ«æŒ‰é’®
        self.face_btn = self.create_func_button(panel, "äººè„¸è¯†åˆ«", "face", wx.Colour(150, 100, 220))
        btn_grid.Add(self.face_btn, 0, wx.EXPAND)
        
        # äººæ•°æ£€æµ‹æŒ‰é’®
        self.crowd_btn = self.create_func_button(panel, "äººæ•°æ£€æµ‹", "crowd", wx.Colour(70, 180, 180))
        btn_grid.Add(self.crowd_btn, 0, wx.EXPAND)
        
        function_sizer.Add(btn_grid, 0, wx.EXPAND | wx.ALL, 10)
        main_sizer.Add(function_sizer, 0, wx.EXPAND | wx.ALL, 10)
        
        # çŠ¶æ€æŒ‡ç¤ºç¯åŒºåŸŸ
        status_sizer = wx.BoxSizer(wx.HORIZONTAL)
        self.status_light = wx.Panel(panel, size=(20, 20))
        self.status_light.SetBackgroundColour(wx.RED)
        status_sizer.Add(self.status_light, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        self.status_label = wx.StaticText(panel, label="çŠ¶æ€: æœªè¿æ¥")
        status_sizer.Add(self.status_label, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        
        # æ·»åŠ ç©ºä½ä¿æŒå¸ƒå±€ç¾è§‚
        status_sizer.AddStretchSpacer(1)
        main_sizer.Add(status_sizer, 0, wx.EXPAND | wx.ALL, 10)
        
        # æ‰©å±•çš„æ—¥å¿—åŒºåŸŸ - ç§»é™¤è§†é¢‘ç›‘æ§åæ‰©å¤§æ­¤åŒºåŸŸ
        log_sizer = wx.StaticBoxSizer(wx.VERTICAL, panel, "ç³»ç»Ÿæ—¥å¿—")
        self.log_text = wx.TextCtrl(panel, style=wx.TE_MULTILINE | wx.TE_READONLY | wx.HSCROLL,
                                  size=(-1, 450))  # å¢åŠ é«˜åº¦
        self.log_text.SetFont(wx.Font(10, wx.FONTFAMILY_TELETYPE, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_NORMAL))
        log_sizer.Add(self.log_text, 1, wx.EXPAND | wx.ALL, 5)
        main_sizer.Add(log_sizer, 1, wx.EXPAND | wx.ALL, 10)  # æ¯”ä¾‹å› å­è®¾ä¸º1ä»¥å ç”¨æ›´å¤šç©ºé—´
        
        panel.SetSizer(main_sizer)
        
        # ç»‘å®šäº‹ä»¶
        self.Bind(wx.EVT_CLOSE, self.on_close)
        self.device_combo.Bind(wx.EVT_COMBOBOX, self.on_device_change)
        self.bind_btn.Bind(wx.EVT_BUTTON, self.on_bind_device)
        self.add_device_btn.Bind(wx.EVT_BUTTON, self.on_add_device)
        self.realtime_btn.Bind(wx.EVT_BUTTON, self.on_realtime)
        self.pose_btn.Bind(wx.EVT_BUTTON, self.on_pose_detection)
        self.fire_btn.Bind(wx.EVT_BUTTON, self.on_fire_detection)
        self.history_btn.Bind(wx.EVT_BUTTON, self.on_history)
        self.face_btn.Bind(wx.EVT_BUTTON, self.on_face_detection)
        self.crowd_btn.Bind(wx.EVT_BUTTON, self.on_crowd_detection)
        
        # æ·»åŠ æ—¥å¿—
        self.log_message("ç³»ç»Ÿå¯åŠ¨æˆåŠŸ")
        self.log_message(f"å½“å‰è®¾å¤‡: {self.current_device['name']}({self.current_device['ip']})")
        
        self.file_list = None  # æ–‡ä»¶åˆ—è¡¨æ§ä»¶
        self.date_combo = None  # æ—¥æœŸé€‰æ‹©æ§ä»¶
    
    def create_func_button(self, parent, label, icon_name, color):
        btn = wx.Button(parent, label=label, size=(-1, 70))
        btn.SetFont(wx.Font(14, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_BOLD))
        btn.SetBackgroundColour(color)
        btn.SetForegroundColour(wx.WHITE)
        
        # è®¾ç½®å›¾æ ‡
        if icon_name == "video":
            icon = "ğŸ“¹"
        elif icon_name == "pose":
            icon = "ğŸ§"
        elif icon_name == "fire":
            icon = "ğŸ”¥"
        elif icon_name == "history":
            icon = "ğŸ•’"
        elif icon_name == "face":
            icon = "ğŸ‘¤"
        elif icon_name == "crowd":
            icon = "ğŸ‘¥"
        else:
            icon = ""
        
        # åˆ›å»ºå‚ç›´å¸ƒå±€
        btn_sizer = wx.BoxSizer(wx.VERTICAL)
        icon_label = wx.StaticText(btn, label=icon)
        icon_label.SetFont(wx.Font(24, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_NORMAL))
        text_label = wx.StaticText(btn, label=label)
        text_label.SetFont(wx.Font(12, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_NORMAL))
        
        btn_sizer.Add(icon_label, 0, wx.ALIGN_CENTER | wx.TOP, 5)
        btn_sizer.Add(text_label, 0, wx.ALIGN_CENTER | wx.BOTTOM, 5)
        btn.SetSizer(btn_sizer)
        btn.Layout()
        
        return btn

    def log_message(self, message):
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_entry = f"[{timestamp}] {message}"
        self.log_text.AppendText(log_entry + "\n")
    
    def on_timer(self, event):
        # æ›´æ–°æ—¶é—´æ˜¾ç¤º
        self.time_display.SetLabel(datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        
        # æ›´æ–°çŠ¶æ€ç¯
        if self.is_receiving:
            self.status_light.SetBackgroundColour(wx.GREEN)
            self.status_label.SetLabel("çŠ¶æ€: è§†é¢‘æµä¼ è¾“ä¸­")
        else:
            self.status_light.SetBackgroundColour(wx.RED)
            self.status_label.SetLabel("çŠ¶æ€: æœªè¿æ¥")
    
    def on_device_change(self, event):
        idx = self.device_combo.GetSelection()
        if idx >= 0 and idx < len(self.devices):
            self.current_device = self.devices[idx]
            self.device_info.SetLabel(
                f"IP: {self.current_device['ip']}\n"
                f"çŠ¶æ€: {'å·²ç»‘å®š' if self.current_device['bound'] else 'æœªç»‘å®š'}"
            )
            self.log_message(f"åˆ‡æ¢åˆ°è®¾å¤‡: {self.current_device['name']}")
    
    def on_bind_device(self, event):
        if not self.current_device['bound']:
            # æ­¤å¤„æ·»åŠ å®é™…çš„è®¾å¤‡ç»‘å®šé€»è¾‘
            self.current_device['bound'] = True
            self.log_message(f"è®¾å¤‡ {self.current_device['name']} ç»‘å®šæˆåŠŸ")
            self.device_info.SetLabel(
                f"IP: {self.current_device['ip']}\nçŠ¶æ€: å·²ç»‘å®š"
            )
            self.bind_btn.SetLabel("è§£é™¤ç»‘å®š")
            self.bind_btn.SetBackgroundColour(wx.Colour(220, 120, 120))
        else:
            self.current_device['bound'] = False
            self.log_message(f"è®¾å¤‡ {self.current_device['name']} è§£é™¤ç»‘å®š")
            self.device_info.SetLabel(
                f"IP: {self.current_device['ip']}\nçŠ¶æ€: æœªç»‘å®š"
            )
            self.bind_btn.SetLabel("ç»‘å®šè®¾å¤‡")
            self.bind_btn.SetBackgroundColour(wx.Colour(100, 180, 100))
    
    def on_add_device(self, event):
        dlg = wx.TextEntryDialog(self, "è¯·è¾“å…¥è®¾å¤‡IPåœ°å€:", "æ·»åŠ æ–°è®¾å¤‡")
        if dlg.ShowModal() == wx.ID_OK:
            ip = dlg.GetValue()
            if self.validate_ip(ip):
                new_device = {
                    "name": f"è®¾å¤‡ {len(self.devices) + 1}",
                    "ip": ip,
                    "user": "",
                    "password": "",
                    "script_path": "",
                    "history_path": "",
                    "bound": False
                }
                self.devices.append(new_device)
                self.device_combo.Append(new_device["name"])
                self.device_combo.SetStringSelection(new_device["name"])
                self.on_device_change(None)
                self.log_message(f"æ·»åŠ æ–°è®¾å¤‡: {ip}")
            else:
                wx.MessageBox("IPåœ°å€æ ¼å¼æ— æ•ˆ!", "é”™è¯¯", wx.OK | wx.ICON_ERROR)
        dlg.Destroy()
    
    def validate_ip(self, ip):
        try:
            parts = ip.split('.')
            if len(parts) != 4:
                return False
            for part in parts:
                if not 0 <= int(part) <= 255:
                    return False
            return True
        except:
            return False
    
    def run_remote_script(self, script_name):
        """åœ¨è®¾å¤‡ç«¯è¿è¡ŒæŒ‡å®šè„šæœ¬"""
        device = self.current_device
        self.log_message(f"å¯åŠ¨è®¾å¤‡ç«¯è„šæœ¬: {script_name}...")
        
        try:
            # åˆ›å»ºSSHè¿æ¥
            ssh = paramiko.SSHClient()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            ssh.connect(device['ip'],
                        username=device['user'],
                        password=device['password'])
            
            # æ‰§è¡Œå‘½ä»¤
            command = f"cd {device['script_path']} && python3 {script_name}"
            ssh.exec_command(command)  # åå°è¿è¡Œï¼Œä¸ç­‰å¾…å®Œæˆ
            
            self.processes[script_name] = ssh
            self.log_message(f"è®¾å¤‡ç«¯è„šæœ¬ {script_name} å¯åŠ¨æˆåŠŸ")
            return True
        except Exception as e:
            self.log_message(f"å¯åŠ¨è®¾å¤‡ç«¯è„šæœ¬å¤±è´¥: {str(e)}")
            wx.MessageBox(f"å¯åŠ¨è®¾å¤‡ç«¯è„šæœ¬å¤±è´¥: {str(e)}", "é”™è¯¯", wx.OK | wx.ICON_ERROR)
            return False
    
    def run_pc_script(self, script_name):
        """åœ¨PCç«¯è¿è¡Œè„šæœ¬"""
        self.log_message(f"å¯åŠ¨ PC ç«¯è„šæœ¬: {script_name}...")
        
        try:
            script_path = os.path.join(self.pc_script_path, script_name)
            if os.path.exists(script_path):
                # å¯åŠ¨è¿›ç¨‹
                proc = subprocess.Popen(["python", script_path],
                                       stdout=subprocess.PIPE,
                                       stderr=subprocess.STDOUT,
                                       creationflags=subprocess.CREATE_NO_WINDOW)
                self.processes[script_name] = proc
                
                # å¯åŠ¨çº¿ç¨‹è¯»å–è¾“å‡º
                threading.Thread(target=self.read_script_output,
                               args=(proc, script_name), daemon=True).start()
                
                self.log_message(f"PC ç«¯è„šæœ¬ {script_name} å¯åŠ¨æˆåŠŸ")
                return True
            else:
                self.log_message(f"è„šæœ¬ä¸å­˜åœ¨: {script_path}")
                wx.MessageBox(f"è„šæœ¬ä¸å­˜åœ¨: {script_path}", "é”™è¯¯", wx.OK | wx.ICON_ERROR)
                return False
        except Exception as e:
            self.log_message(f"å¯åŠ¨ PC ç«¯è„šæœ¬å¤±è´¥: {str(e)}")
            wx.MessageBox(f"å¯åŠ¨ PC ç«¯è„šæœ¬å¤±è´¥: {str(e)}", "é”™è¯¯", wx.OK | wx.ICON_ERROR)
            return False
    
    def read_script_output(self, proc, script_name):
        """è¯»å–è„šæœ¬è¾“å‡ºåˆ°æ—¥å¿—"""
        while proc.poll() is None:
            line = proc.stdout.readline()
            if line:
                self.log_message(f"[{script_name}] {line.decode().strip()}")
            time.sleep(0.1)
    
    def start_video_stream(self):
        """å¯åŠ¨è§†é¢‘æµæ¥æ”¶"""
        if self.is_receiving:
            self.log_message("è§†é¢‘æµå·²å¯åŠ¨ï¼Œæ— éœ€é‡å¤å¯åŠ¨")
            return
        
        self.is_receiving = True
        self.receiving_thread = threading.Thread(target=self.receive_video_stream, daemon=True)
        self.receiving_thread.start()
        self.log_message("è§†é¢‘æµæ¥æ”¶å¯åŠ¨")
    
    def stop_video_stream(self):
        """åœæ­¢è§†é¢‘æµæ¥æ”¶"""
        self.is_receiving = False
        
        if self.receiving_thread and self.receiving_thread.is_alive():
            self.receiving_thread.join(timeout=2.0)
        
        self.log_message("è§†é¢‘æµæ¥æ”¶åœæ­¢")
    
    def receive_video_stream(self):
        """æ¥æ”¶è§†é¢‘æµå¹¶æ˜¾ç¤º"""
        self.log_message("è¿æ¥è§†é¢‘æµ...")
        
        try:
            # åˆ›å»ºsocketè¿æ¥
            client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            client_socket.connect((self.current_device['ip'], self.video_port))
            connection = client_socket.makefile('rb')
            self.log_message("è§†é¢‘æµè¿æ¥æˆåŠŸ")
            
            while self.is_receiving:
                # æ¥æ”¶å¸§å¤§å°ä¿¡æ¯
                frame_size_data = connection.read(4)
                if len(frame_size_data) != 4:
                    break
                
                frame_size = int.from_bytes(frame_size_data, byteorder='big')
                
                # æ¥æ”¶å¸§æ•°æ®
                frame_data = connection.read(frame_size)
                if len(frame_data) != frame_size:
                    break
                
                # è½¬æ¢ä¸ºå›¾åƒ
                image = cv2.imdecode(np.frombuffer(frame_data, dtype=np.uint8), cv2.IMREAD_COLOR)
            
            # æ¸…ç†
            connection.close()
            client_socket.close()
            self.log_message("è§†é¢‘æµè¿æ¥å…³é—­")
        except Exception as e:
            self.log_message(f"è§†é¢‘æµæ¥æ”¶é”™è¯¯: {str(e)}")
    
    def on_realtime(self, event):
        try:
            # 1.ç¡®ä¿è§†é¢‘æµæ¥æ”¶ç¨‹åºå¯åŠ¨
            if not self.is_receiver_running():
                self.start_receiver_program()  # æ–°æ·»åŠ çš„æ–¹æ³•
            
            # 2.ç¡®ä¿è®¾å¤‡ç«¯æœåŠ¡å¯åŠ¨
            self.start_device_service()
            
            # 3.å¯åŠ¨è§†é¢‘æ¥æ”¶çº¿ç¨‹
            self.is_receiving = True
            self.receiving_thread = threading.Thread(target=self.receive_video_stream)
            self.receiving_thread.start()
        except Exception as e:
            self.log_message(f"å¯åŠ¨å¤±è´¥: {str(e)}")
    
    def is_receiver_running(self):
        """æ£€æŸ¥æ¥æ”¶ç¨‹åºæ˜¯å¦åœ¨è¿è¡Œ"""
        for proc in psutil.process_iter(['name']):
            if 'python' in proc.info['name'] and 'receiver.py' in proc.cmdline():
                return True
        return False
    
    def start_receiver_program(self):
        """ç¡®ä¿PCç«¯æ¥æ”¶ç¨‹åºå¯åŠ¨"""
        script_path = os.path.join(self.pc_script_path, "receiver.py")
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if not os.path.exists(script_path):
            raise FileNotFoundError(f"receiver.py not found at {script_path}")
        
        # å¯åŠ¨ç¨‹åº
        proc = subprocess.Popen(["python", script_path])
        self.processes["receiver.py"] = proc
        self.log_message("è§†é¢‘æ¥æ”¶ç¨‹åºå·²å¯åŠ¨")
    
    def on_pose_detection(self, event):
        """å¯åŠ¨å§¿æ€è¯†åˆ«"""
        self.log_message("å¯åŠ¨å§¿æ€è¯†åˆ«åˆ†æ...")
        
        # åœæ­¢ä¹‹å‰çš„å¤„ç†
        self.stop_all_processes()
        
        # è¿è¡Œè®¾å¤‡ç«¯è„šæœ¬
        self.run_remote_script("fall_detection.py")
        
        # è¿è¡ŒPCç«¯è„šæœ¬
        self.run_pc_script("alert_receiver_pc.py")
        
        # å¯åŠ¨è§†é¢‘æµ
        self.start_video_stream()
    
    def on_fire_detection(self, event):
        """å¯åŠ¨ç«ç„°æ£€æµ‹"""
        self.log_message("å¯åŠ¨ç«ç„°æ£€æµ‹åˆ†æ...")
        
        # åœæ­¢ä¹‹å‰çš„å¤„ç†
        self.stop_all_processes()
        
        # è¿è¡Œè®¾å¤‡ç«¯è„šæœ¬
        self.run_remote_script("fire_detection_sensor.py")
        
        # è¿è¡ŒPCç«¯è„šæœ¬
        self.run_pc_script("pc_alert_notifier.py")
        
        # å¯åŠ¨è§†é¢‘æµ
        self.start_video_stream()
    
    def on_face_detection(self, event):
        """å¯åŠ¨äººè„¸è¯†åˆ«"""
        self.log_message("å¯åŠ¨äººè„¸è¯†åˆ«åˆ†æ...")
        
        # åœæ­¢ä¹‹å‰çš„å¤„ç†
        self.stop_all_processes()
        
        # è¿è¡Œè®¾å¤‡ç«¯è„šæœ¬
        self.run_remote_script("face.py")
        
        # è¿è¡ŒPCç«¯è„šæœ¬
        self.run_pc_script("pc_monitor.py")
        
        # å¯åŠ¨è§†é¢‘æµ
        self.start_video_stream()
    
    def on_crowd_detection(self, event):
        """å¯åŠ¨äººæ•°æ£€æµ‹"""
        self.log_message("å¯åŠ¨äººæ•°æ£€æµ‹åˆ†æ...")
        
        # åœæ­¢ä¹‹å‰çš„å¤„ç†
        self.stop_all_processes()
        
        # è¿è¡Œè®¾å¤‡ç«¯è„šæœ¬
        self.run_remote_script("security_monitor.py")
        
        # è¿è¡ŒPCç«¯è„šæœ¬
        self.run_pc_script("security.py")
        
        # å¯åŠ¨è§†é¢‘æµ
        self.start_video_stream()
    
    def on_history(self, event):
        """æŸ¥çœ‹å†å²ç›‘æ§"""
        self.log_message("åŠ è½½å†å²ç›‘æ§æ•°æ®...")
        
        # åˆ›å»ºå†å²æ•°æ®çª—å£
        history_dlg = wx.Dialog(self, title="å†å²ç›‘æ§æ•°æ®", size=(900, 600))
        panel = wx.Panel(history_dlg)
        sizer = wx.BoxSizer(wx.VERTICAL)
        
        # æ ‡é¢˜
        title = wx.StaticText(panel, label="å†å²ç›‘æ§å½•åƒ")
        title.SetFont(wx.Font(16, wx.FONTFAMILY_DEFAULT, wx.FONTSTYLE_NORMAL, wx.FONTWEIGHT_BOLD))
        sizer.Add(title, 0, wx.ALL | wx.ALIGN_CENTER, 10)
        
        # è®¾å¤‡ä¿¡æ¯æ˜¾ç¤º
        device_info = wx.StaticText(panel, label=f"è®¾å¤‡: {self.current_device['name']} ({self.current_device['ip']})\nè·¯å¾„: {self.current_device['history_path']}/monitor_videos/")
        sizer.Add(device_info, 0, wx.ALL | wx.ALIGN_CENTER, 10)
        
        # æ—¥æœŸé€‰æ‹©
        date_sizer = wx.BoxSizer(wx.HORIZONTAL)
        date_label = wx.StaticText(panel, label="é€‰æ‹©æ—¥æœŸ:")
        date_sizer.Add(date_label, 0, wx.ALL | wx.ALIGN_CENTER_VERTICAL, 5)
        
        # æ·»åŠ æ—¥æœŸä¸‹æ‹‰æ¡†
        dates = self.get_available_dates()
        self.date_combo = wx.ComboBox(panel, choices=dates, style=wx.CB_READONLY)
        date_sizer.Add(self.date_combo, 1, wx.ALL | wx.EXPAND, 5)
        
        sizer.Add(date_sizer, 0, wx.EXPAND | wx.ALL, 5)
        
        # æ–‡ä»¶åˆ—è¡¨
        self.file_list = wx.ListBox(panel, style=wx.LB_SINGLE)
        sizer.Add(self.file_list, 1, wx.EXPAND | wx.ALL, 5)
        
        # æ’­æ”¾æŒ‰é’®
        play_btn = wx.Button(panel, label="æ’­æ”¾è§†é¢‘")
        sizer.Add(play_btn, 0, wx.ALL | wx.ALIGN_CENTER, 10)
        
        panel.SetSizer(sizer)
        
        # ç»‘å®šäº‹ä»¶
        self.date_combo.Bind(wx.EVT_COMBOBOX, self.on_date_select)
        play_btn.Bind(wx.EVT_BUTTON, self.on_play_history)
        
        history_dlg.ShowModal()
        history_dlg.Destroy()
    
    def get_available_dates(self):
        """è·å–å¯ç”¨çš„å†å²æ—¥æœŸï¼ˆæ¨¡æ‹Ÿï¼‰"""
        # åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»è®¾å¤‡è·å–å¯ç”¨æ—¥æœŸ
        return ["2025-07-01", "2025-07-02", "2025-07-03", "2025-07-04"]
    
    def on_date_select(self, event):
        """å½“é€‰æ‹©æ—¥æœŸæ—¶æ›´æ–°æ–‡ä»¶åˆ—è¡¨"""
        date = self.date_combo.GetValue()
        self.log_message(f"åŠ è½½æ—¥æœŸ: {date} çš„å†å²æ–‡ä»¶...")
        
        # æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
        self.file_list.Clear()
        
        # æ¨¡æ‹Ÿè·å–æ–‡ä»¶åˆ—è¡¨
        files = [f"security_{date}_{time}.mp4" 
                for time in ["09:00", "12:00", "15:00", "18:00", "21:00"]]
        
        # æ·»åŠ åˆ°åˆ—è¡¨æ§ä»¶
        for file in files:
            self.file_list.Append(file)
    
    def on_play_history(self, event):
        """æ’­æ”¾é€‰ä¸­çš„å†å²è§†é¢‘"""
        selection = self.file_list.GetSelection()
        if selection != wx.NOT_FOUND:
            file_name = self.file_list.GetString(selection)
            self.log_message(f"å¼€å§‹æ’­æ”¾å†å²è§†é¢‘: {file_name}")
            
            # å®é™…åº”ç”¨ä¸­åº”è¯¥ä»è®¾å¤‡ä¸‹è½½è§†é¢‘å¹¶æ’­æ”¾
            wx.MessageBox(f"å³å°†æ’­æ”¾è§†é¢‘: {file_name}", "å†å²å›æ”¾", wx.OK | wx.ICON_INFORMATION)
        else:
            wx.MessageBox("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶", "é”™è¯¯", wx.OK | wx.ICON_ERROR)
    
    def stop_all_processes(self):
        """åœæ­¢æ‰€æœ‰è¿è¡Œçš„è¿›ç¨‹"""
        self.stop_video_stream()
        
        # åœæ­¢PCç«¯è¿›ç¨‹
        for name, proc in self.processes.items():
            if isinstance(proc, subprocess.Popen):  # PCç«¯è¿›ç¨‹
                proc.kill()
                self.log_message(f"å·²åœæ­¢PCç«¯è¿›ç¨‹: {name}")
            elif isinstance(proc, paramiko.SSHClient):  # SSHè¿æ¥
                proc.exec_command("pkill -f '.py'")
                self.log_message(f"å·²å‘é€åœæ­¢ä¿¡å·åˆ°è®¾å¤‡ç«¯è„šæœ¬: {name}")
        
        # æ¸…ç©ºè¿›ç¨‹å­—å…¸
        self.processes.clear()
    
    def on_close(self, event):
        """å…³é—­çª—å£æ—¶æ¸…ç†èµ„æº"""
        self.stop_all_processes()
        self.Destroy()
    
    def start_device_service(self):
        """å¯åŠ¨è®¾å¤‡ç«¯æœåŠ¡è„šæœ¬ï¼ˆæ¨¡æ‹Ÿï¼‰"""
        self.log_message("å¯åŠ¨è®¾å¤‡ç«¯æœåŠ¡...")
        # å®é™…åº”ç”¨ä¸­åº”è¯¥é€šè¿‡SSHæ‰§è¡Œè„šæœ¬
        self.log_message("è®¾å¤‡ç«¯æœåŠ¡å·²å¯åŠ¨")

if __name__ == "__main__":
    app = wx.App()
    frame = IndustrialSecurityClient()
    frame.Show()
    app.MainLoop()
