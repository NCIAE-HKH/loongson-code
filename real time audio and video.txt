#!/usr/bin/env python3
# sender.py - é¾™èŠ¯æ¿éŸ³è§†é¢‘å‘é€ç«¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
import cv2
import socket
import time
import numpy as np
import logging
import subprocess
import sys
import threading
import os

# ============== é…ç½®åŒºåŸŸ ==============
TARGET_IP = "192.168.1.166"  # æ¥æ”¶ç«¯PCçš„å®é™…IPåœ°å€
VIDEO_PORT = 5002
AUDIO_PORT = 5003
VIDEO_FRAME_WIDTH = 640
VIDEO_FRAME_HEIGHT = 480
VIDEO_FPS = 15                 # ç›®æ ‡å¸§ç‡ï¼ˆæ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
AUDIO_SAMPLE_RATE = 44100      # éŸ³é¢‘é‡‡æ ·ç‡
AUDIO_CHANNELS = 1            # éŸ³é¢‘é€šé“æ•°
# =====================================

class MediaStreamer:
    def __init__(self):
        # çŠ¶æ€æ§åˆ¶
        self.active = True
        
        # ç½‘ç»œå¥—æ¥å­—
        self.video_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.audio_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.video_socket.setsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF, 10 * 1024 * 1024)
        
        # è§†é¢‘æ€§èƒ½è®¡æ•°å™¨
        self.frame_count = 0
        self.start_time = time.time()
        
        # é…ç½®æ—¥å¿—
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s [%(levelname)s] %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S',
            handlers=[logging.StreamHandler(sys.stdout)]
        )
        
        # åˆå§‹åŒ–æ‘„åƒå¤´
        self.cap = self.initialize_camera()
        
        # åˆå§‹åŒ–éŸ³é¢‘
        self.audio_process = None
        
        logging.info("âœ… å‘é€ç«¯åˆå§‹åŒ–å®Œæˆ")

    def initialize_camera(self):
        """åˆå§‹åŒ–æ‘„åƒå¤´å¹¶è®¾ç½®å‚æ•°"""
        cap = cv2.VideoCapture(0)
        if not cap.isOpened():
            logging.error("âŒ æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼Œåˆ›å»ºè™šæ‹Ÿæº")
            return self.create_virtual_camera()
            
        # å°è¯•è®¾ç½®åˆ†è¾¨ç‡
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, VIDEO_FRAME_WIDTH)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, VIDEO_FRAME_HEIGHT)
        
        # æ‰“å°å®é™…åˆ†è¾¨ç‡
        actual_width = cap.get(cv2.CAP_PROP_FRAME_WIDTH)
        actual_height = cap.get(cv2.CAP_PROP_FRAME_HEIGHT)
        logging.info(f"ğŸ“· æ‘„åƒå¤´åˆ†è¾¨ç‡: {int(actual_width)}x{int(actual_height)}")
        
        return cap

    def create_virtual_camera(self):
        """åˆ›å»ºè™šæ‹Ÿæ‘„åƒå¤´"""
        class VirtualCamera:
            def __init__(self):
                self.frame_count = 0
                
            def read(self):
                img = np.zeros((VIDEO_FRAME_HEIGHT, VIDEO_FRAME_WIDTH, 3), dtype=np.uint8)
                cv2.putText(img, "Virtual Camera", 
                           (50, VIDEO_FRAME_HEIGHT//2 - 20), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 255, 0), 2)
                cv2.putText(img, "Press 'q' to quit", 
                           (50, VIDEO_FRAME_HEIGHT//2 + 30), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 1)
                self.frame_count += 1
                return True, img
                
            def isOpened(self):
                return True
                
            def release(self):
                pass
        
        return VirtualCamera()

    def start_audio_capture(self):
        """å¯åŠ¨ALSAéŸ³é¢‘é‡‡é›†"""
        try:
            # æ£€æŸ¥arecordæ˜¯å¦å¯ç”¨
            subprocess.check_call(["arecord", "--version"], 
                                 stdout=subprocess.DEVNULL, 
                                 stderr=subprocess.DEVNULL)
            
            # æ„å»ºarecordå‘½ä»¤
            cmd = [
                "arecord",
                "-f", "S16_LE",      # 16ä½å°ç«¯æ ¼å¼
                "-r", str(AUDIO_SAMPLE_RATE),
                "-c", str(AUDIO_CHANNELS),
                "-t", "raw",         # åŸå§‹æ ¼å¼
                "-"                  # è¾“å‡ºåˆ°stdout
            ]
            
            # å¯åŠ¨éŸ³é¢‘é‡‡é›†è¿›ç¨‹
            self.audio_process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE
            )
            
            logging.info(f"ğŸ™ï¸ éŸ³é¢‘é‡‡é›†å·²å¯åŠ¨ @ {AUDIO_SAMPLE_RATE}Hz")
            
            # å¯åŠ¨éŸ³é¢‘å‘é€çº¿ç¨‹
            audio_thread = threading.Thread(target=self.audio_sending_thread)
            audio_thread.daemon = True
            audio_thread.start()
            
            return True
            
        except (FileNotFoundError, subprocess.CalledProcessError):
            logging.error("âŒ arecordå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡éŸ³é¢‘é‡‡é›†")
            logging.info("è¯·å®‰è£…alsa-utils: sudo apt install alsa-utils")
            return False

    def audio_sending_thread(self):
        """éŸ³é¢‘å‘é€çº¿ç¨‹"""
        logging.info("ğŸ”Š éŸ³é¢‘å‘é€çº¿ç¨‹å¯åŠ¨")
        audio_packet_size = 1024 * AUDIO_CHANNELS * 2  # 16ä½ * é€šé“æ•°
        
        while self.active and self.audio_process.poll() is None:
            try:
                # è¯»å–éŸ³é¢‘æ•°æ®
                audio_data = self.audio_process.stdout.read(audio_packet_size)
                if audio_data:
                    self.audio_socket.sendto(audio_data, (TARGET_IP, AUDIO_PORT))
                else:
                    time.sleep(0.01)
            except Exception as e:
                logging.error(f"ğŸ”´ éŸ³é¢‘å‘é€é”™è¯¯: {str(e)}")
                break

    def video_capture_thread(self):
        """è§†é¢‘æ•è·çº¿ç¨‹"""
        logging.info("ğŸ“¹ è§†é¢‘æ•è·çº¿ç¨‹å¯åŠ¨")
        
        # å¸§ç‡æ§åˆ¶å˜é‡
        frame_interval = 1.0 / VIDEO_FPS
        last_frame_time = time.time()
        
        while self.active:
            try:
                # æ§åˆ¶å¸§ç‡
                current_time = time.time()
                sleep_time = max(0, last_frame_time + frame_interval - current_time)
                time.sleep(sleep_time)
                last_frame_time = current_time
                
                # è¯»å–è§†é¢‘å¸§
                ret, frame = self.cap.read()
                if not ret:
                    logging.warning("âš ï¸ è¯»å–å¸§å¤±è´¥ï¼Œè·³è¿‡")
                    continue
                
                # JPEGå‹ç¼©ï¼ˆé™ä½è´¨é‡ä»¥å‡å°å¸¦å®½ï¼‰
                _, img_encoded = cv2.imencode('.jpg', frame, [
                    int(cv2.IMWRITE_JPEG_QUALITY), 70
                ])
                
                # å‘é€è§†é¢‘æ•°æ®
                self.video_socket.sendto(img_encoded.tobytes(), (TARGET_IP, VIDEO_PORT))
                
                # æ›´æ–°å¸§è®¡æ•°
                self.frame_count += 1
                
                # æ¯ç§’æ˜¾ç¤ºå¸§ç‡
                elapsed = time.time() - self.start_time
                if elapsed >= 1.0:
                    fps = self.frame_count / elapsed
                    logging.info(f"ğŸ“¹ è§†é¢‘å¸§ç‡: {fps:.1f} FPS")
                    self.frame_count = 0
                    self.start_time = time.time()
                    
            except Exception as e:
                logging.error(f"ğŸ”´ è§†é¢‘æ•è·é”™è¯¯: {str(e)}")
                time.sleep(0.1)

    def start_streaming(self):
        """å¯åŠ¨éŸ³è§†é¢‘æµä¼ è¾“"""
        logging.info(f"ğŸš€ ç›®æ ‡åœ°å€: {TARGET_IP}:{VIDEO_PORT}(è§†é¢‘)/{AUDIO_PORT}(éŸ³é¢‘)")
        
        # å¯åŠ¨éŸ³é¢‘é‡‡é›†
        audio_started = self.start_audio_capture()
        
        # å¯åŠ¨è§†é¢‘çº¿ç¨‹
        video_thread = threading.Thread(target=self.video_capture_thread)
        video_thread.daemon = True
        video_thread.start()
        
        # ç­‰å¾…é€€å‡º
        try:
            while self.active:
                time.sleep(1)
        except KeyboardInterrupt:
            self.active = False
        finally:
            self.cleanup()

    def cleanup(self):
        """èµ„æºæ¸…ç†"""
        self.active = False
        time.sleep(0.1)  # ç»™çº¿ç¨‹æ—¶é—´é€€å‡º
        
        # å…³é—­æ‘„åƒå¤´
        if hasattr(self.cap, 'release'):
            try:
                self.cap.release()
            except:
                pass
        
        # å…³é—­éŸ³é¢‘è¿›ç¨‹
        if self.audio_process and self.audio_process.poll() is None:
            try:
                self.audio_process.terminate()
                self.audio_process.wait(timeout=1.0)
            except:
                pass
        
        # å…³é—­å¥—æ¥å­—
        self.video_socket.close()
        self.audio_socket.close()
        
        logging.info("âœ… èµ„æºå·²é‡Šæ”¾")

if __name__ == "__main__":
    try:
        streamer = MediaStreamer()
        streamer.start_streaming()
    except Exception as e:
        logging.error(f"ğŸ”´ ç¨‹åºå¼‚å¸¸: {str(e)}")


