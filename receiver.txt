#!/usr/bin/env python3
# receiver.py - éŸ³è§†é¢‘æ¥æ”¶ç«¯ï¼ˆå®Œæ•´ç‰ˆï¼‰
import cv2
import numpy as np
import socket
import threading
import time
import logging
import sys
import sounddevice as sd
import queue

# ============== é…ç½®åŒºåŸŸ ==============
VIDEO_PORT = 5002
AUDIO_PORT = 5003
DISPLAY_SIZE = (640, 480)  # æ˜¾ç¤ºçª—å£å¤§å°
BUFFER_SIZE = 65535        # UDPç¼“å†²åŒºå¤§å°
AUDIO_SAMPLE_RATE = 44100 # éŸ³é¢‘é‡‡æ ·ç‡
AUDIO_CHANNELS = 1        # éŸ³é¢‘é€šé“æ•°
# =====================================

class MediaReceiver:
    def __init__(self):
        # çŠ¶æ€æ§åˆ¶
        self.running = True
        self.window_name = "Loongson Stream"
		
		# åˆå§‹åŒ–å…³é”®å±æ€§ï¼ˆæ·»åŠ ä¸‹é¢è¿™ä¸€è¡Œä¿®å¤é”™è¯¯ï¼‰
        self.last_resize_time = time.time()  # è®°å½•çª—å£æ“ä½œæ—¶é—´
        self.last_video_fps = 0.0  # æ·»åŠ è¿™ä¸€è¡Œè§£å†³"last_video_fps"é”™è¯¯
        self.frame_queue = queue.Queue()
        self.audio_queue = queue.Queue()
		# åˆ›å»ºçª—å£ä½†ä¸ç«‹å³è°ƒæ•´å¤§å°
        cv2.namedWindow(self.window_name, cv2.WINDOW_NORMAL)
        
        # ç½‘ç»œå¥—æ¥å­—
        self.video_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.audio_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        
        # å¥—æ¥å­—è®¾ç½®
        self.video_socket.setsockopt(socket.SOL_SOCKET, socket.SO_RCVBUF, 10 * 1024 * 1024)
        self.audio_socket.setsockopt(socket.SOL_SOCKET, socket.SO_RCVBUF, 10 * 1024 * 1024)
        
        # å¸§é˜Ÿåˆ—
        self.frame_queue = queue.Queue(maxsize=2)  # è§†é¢‘å¸§é˜Ÿåˆ—
        
        # éŸ³é¢‘é˜Ÿåˆ—
        self.audio_queue = queue.Queue(maxsize=100)  # éŸ³é¢‘æ•°æ®é˜Ÿåˆ—
        
        # æ€§èƒ½è®¡æ•°å™¨
        self.video_frame_count = 0
        self.audio_packet_count = 0
        self.start_time = time.time()
        
        # é…ç½®æ—¥å¿—
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s [%(levelname)s] %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S',
            handlers=[logging.StreamHandler(sys.stdout)]
        )
        
        # åˆå§‹åŒ–éŸ³é¢‘è¾“å‡º
        self.init_audio_output()
        
        # åˆå§‹åŒ–è§†é¢‘çª—å£
        cv2.namedWindow("Loongson Stream", cv2.WINDOW_NORMAL)
        cv2.resizeWindow("Loongson Stream", DISPLAY_SIZE[0], DISPLAY_SIZE[1])
        cv2.moveWindow("Loongson Stream", 100, 100)
        
        logging.info("âœ… æ¥æ”¶ç«¯åˆå§‹åŒ–å®Œæˆ")

    def init_audio_output(self):
        """åˆå§‹åŒ–éŸ³é¢‘è¾“å‡ºæµ"""
        try:
            # æŸ¥è¯¢å¯ç”¨çš„éŸ³é¢‘è¾“å‡ºè®¾å¤‡
            devices = sd.query_devices()
            output_device = None
            
            # ä¼˜å…ˆé€‰æ‹©æ”¯æŒ44100Hzé‡‡æ ·çš„è®¾å¤‡
            for idx, dev in enumerate(devices):
                if dev['max_output_channels'] > 0 and AUDIO_SAMPLE_RATE <= dev['default_samplerate']:
                    output_device = idx
                    break
            
            if output_device is None:
                output_device = sd.default.device[1]
            
            # åˆ›å»ºéŸ³é¢‘è¾“å‡ºæµ
            self.audio_stream = sd.OutputStream(
                samplerate=AUDIO_SAMPLE_RATE,
                channels=AUDIO_CHANNELS,
                dtype='int16',
                blocksize=1024,
                device=output_device,
                callback=self.audio_callback
            )
            
            self.audio_stream.start()
            logging.info(f"ğŸ”Š éŸ³é¢‘è¾“å‡ºå·²å¯åŠ¨ @ {AUDIO_SAMPLE_RATE}Hz (è®¾å¤‡: {devices[output_device]['name']})")
            
        except Exception as e:
            logging.error(f"âŒ éŸ³é¢‘è¾“å‡ºåˆå§‹åŒ–å¤±è´¥: {str(e)}")
            self.audio_stream = None

    def audio_callback(self, outdata, frames, time_info, status):
        """éŸ³é¢‘æ’­æ”¾å›è°ƒå‡½æ•°"""
        if self.audio_queue.empty():
            outdata.fill(0)  # é˜Ÿåˆ—ä¸ºç©ºæ—¶è¾“å‡ºé™éŸ³
            return
        
        try:
            # ä»é˜Ÿåˆ—è·å–éŸ³é¢‘æ•°æ®
            audio_data = self.audio_queue.get_nowait()
            outdata[:] = np.frombuffer(audio_data, dtype=np.int16).reshape(frames, AUDIO_CHANNELS)
        except queue.Empty:
            outdata.fill(0)
        except Exception as e:
            logging.error(f"ğŸ”´ éŸ³é¢‘æ’­æ”¾é”™è¯¯: {str(e)}")
            outdata.fill(0)

    def video_receive_thread(self):
        """è§†é¢‘æ¥æ”¶çº¿ç¨‹"""
        logging.info("ğŸ“¹ è§†é¢‘æ¥æ”¶çº¿ç¨‹å¯åŠ¨")
        
        # ç»‘å®šç«¯å£
        self.video_socket.bind(('0.0.0.0', VIDEO_PORT))
        self.video_socket.settimeout(0.1)
        
        while self.running:
            try:
                # æ¥æ”¶UDPæ•°æ®åŒ…
                data, _ = self.video_socket.recvfrom(BUFFER_SIZE)
                
                # è½¬æ¢ä¸ºå›¾åƒå¸§
                img_array = np.frombuffer(data, dtype=np.uint8)
                frame = cv2.imdecode(img_array, cv2.IMREAD_COLOR)
                
                if frame is not None:
                    # æ·»åŠ åˆ°å¸§é˜Ÿåˆ—
                    try:
                        self.frame_queue.put_nowait(frame)
                        self.video_frame_count += 1
                    except queue.Full:
                        pass  # é˜Ÿåˆ—æ»¡æ—¶è·³è¿‡
                
                # æ¯ç§’æ˜¾ç¤ºæ¥æ”¶ç»Ÿè®¡
                elapsed = time.time() - self.start_time
                if elapsed > 1.0:
                    fps = self.video_frame_count / elapsed
                    logging.info(f"ğŸ“¦ æ¥æ”¶å¸§ç‡: {fps:.1f} FPS")
                    self.video_frame_count = 0
                    self.start_time = time.time()
                    
            except socket.timeout:
                continue  # è¶…æ—¶æ­£å¸¸
            except Exception as e:
                logging.error(f"ğŸ”´ è§†é¢‘æ¥æ”¶é”™è¯¯: {str(e)}")

    def audio_receive_thread(self):
        """éŸ³é¢‘æ¥æ”¶çº¿ç¨‹"""
        logging.info("ğŸ”Š éŸ³é¢‘æ¥æ”¶çº¿ç¨‹å¯åŠ¨")
        
        # ç»‘å®šç«¯å£
        self.audio_socket.bind(('0.0.0.0', AUDIO_PORT))
        self.audio_socket.settimeout(0.1)
        
        while self.running:
            try:
                # æ¥æ”¶éŸ³é¢‘æ•°æ®
                data, _ = self.audio_socket.recvfrom(4096)
                
                # æ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—
                try:
                    self.audio_queue.put_nowait(data)
                    self.audio_packet_count += 1
                except queue.Full:
                    pass  # é˜Ÿåˆ—æ»¡æ—¶è·³è¿‡
                
            except socket.timeout:
                continue  # è¶…æ—¶æ­£å¸¸
            except Exception as e:
                logging.error(f"ğŸ”´ éŸ³é¢‘æ¥æ”¶é”™è¯¯: {str(e)}")

    def display_thread(self):
        """è§†é¢‘æ˜¾ç¤ºçº¿ç¨‹"""
        FONT = cv2.FONT_HERSHEY_SIMPLEX
        
        # OpenCV 3.2.0å…¼å®¹æ€§å¤„ç†
        self.last_resize_time = time.time()
        display_size = (640, 480)  # æ˜ç¡®æŒ‡å®šæ˜¾ç¤ºå°ºå¯¸
    
        try:
            # å°è¯•è°ƒæ•´çª—å£å¤§å°
            cv2.resizeWindow(self.window_name, display_size[0], display_size[1])
        except:
            # æ—§ç‰ˆOpenCVå¯èƒ½éœ€è¦é¢å¤–çš„å»¶è¿Ÿ
            time.sleep(0.5)
            cv2.resizeWindow(self.window_name, display_size[0], display_size[1])
    
        # å¸§ç‡è®¡ç®—åˆå§‹åŒ–
        last_fps_time = time.time()
        frame_count = 0 
        
        while self.running:
            try:
                # å°è¯•è·å–æ–°å¸§
                frame = self.frame_queue.get(timeout=1.0)
                frame_count += 1
				# è®¡ç®—FPSï¼ˆä»£æ›¿ç›´æ¥ä½¿ç”¨last_video_fpsï¼‰
                current_time = time.time()
                if current_time - last_fps_time >= 1.0:
                    fps = frame_count / (current_time - last_fps_time)
                    self.last_video_fps = fps  # æ›´æ–°å±æ€§å€¼
                    logging.info(f"æ¥æ”¶å¸§ç‡ï¼š{fps:.1f} FPS")
                    frame_count = 0
                    last_fps_time = current_time
            
                # æ·»åŠ å¸§ç‡æ˜¾ç¤º
                fps_text = f"FPS: {self.last_video_fps:.1f}"
                cv2.putText(frame, fps_text, (10, 30), 
                             cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            
                # æ›´æ–°è¿æ¥çŠ¶æ€
                connection_status = "å·²è¿æ¥"
                last_status_time = time.time()
                
                # åˆ›å»ºçŠ¶æ€è¦†ç›–å±‚
                overlay = frame.copy()
                cv2.rectangle(overlay, (0, 0), (frame.shape[1], 80), (0, 0, 0), -1)
                cv2.addWeighted(overlay, 0.5, frame, 0.5, 0, frame)
                
                # åˆ›å»ºè‹±æ–‡çŠ¶æ€ä¿¡æ¯
                fps_text = f"FPS: {self.last_video_fps:.1f}"
                status_text = f"Status: Connected"
                help_text = "Press 'q' to quit"
            
                # æ·»åŠ çŠ¶æ€ä¿¡æ¯ï¼ˆä½¿ç”¨è‹±æ–‡å­—ä½“ï¼‰
                cv2.putText(frame, fps_text, (10, 30), FONT, 0.7, (0, 255, 0), 2)
                cv2.putText(frame, status_text, (10, 60), FONT, 0.7, (0, 255, 0), 2)
                cv2.putText(frame, help_text, (frame.shape[1]-200, frame.shape[0]-10), 
                            FONT, 0.5, (0, 200, 200), 1)
                
                # æ˜¾ç¤ºå›¾åƒ
                cv2.imshow(self.window_name, frame)
                
            except queue.Empty:
                # æ˜¾ç¤ºç­‰å¾…ç”»é¢ï¼ˆä½¿ç”¨è‹±æ–‡ï¼‰
                waiting_img = np.zeros((DISPLAY_SIZE[1], DISPLAY_SIZE[0], 3), dtype=np.uint8)
                cv2.putText(waiting_img, "Status: Connecting...",
                            (50, DISPLAY_SIZE[1]//2-20), FONT, 0.8, (0, 200, 200), 2)
                cv2.putText(waiting_img, "Waiting for video stream",
                            (50, DISPLAY_SIZE[1]//2+20), FONT, 0.8, (0, 200, 200), 2)
                cv2.imshow("Loongson Stream", waiting_img)
            # æ£€æŸ¥é€€å‡ºé”®
            key = cv2.waitKey(1) & 0xFF
            if key == ord('q'):
                self.running = False
                break

    def start(self):
        """å¯åŠ¨æ¥æ”¶ç«¯"""
        logging.info(f"ğŸ“¡ ç›‘å¬ç«¯å£: {VIDEO_PORT} (è§†é¢‘) | {AUDIO_PORT} (éŸ³é¢‘)")
        
        # å¯åŠ¨è§†é¢‘æ¥æ”¶çº¿ç¨‹
        video_thread = threading.Thread(target=self.video_receive_thread)
        video_thread.daemon = True
        video_thread.start()
        
        # å¯åŠ¨éŸ³é¢‘æ¥æ”¶çº¿ç¨‹
        audio_thread = threading.Thread(target=self.audio_receive_thread)
        audio_thread.daemon = True
        audio_thread.start()
        
        # åœ¨ä¸»çº¿ç¨‹è¿è¡Œæ˜¾ç¤º
        self.display_thread()
        
        # æ¸…ç†èµ„æº
        self.cleanup()

    def cleanup(self):
        """èµ„æºæ¸…ç†"""
        self.running = False
        cv2.destroyAllWindows()
        
        # å…³é—­å¥—æ¥å­—
        self.video_socket.close()
        self.audio_socket.close()
        
        # å…³é—­éŸ³é¢‘æµ
        if self.audio_stream:
            self.audio_stream.stop()
            self.audio_stream.close()
        
        logging.info("âœ… èµ„æºå·²é‡Šæ”¾")

if __name__ == "__main__":
    try:
        receiver = MediaReceiver()
        receiver.start()
    except Exception as e:
        logging.error(f"ğŸ”´ æ¥æ”¶ç«¯é”™è¯¯: {str(e)}")
